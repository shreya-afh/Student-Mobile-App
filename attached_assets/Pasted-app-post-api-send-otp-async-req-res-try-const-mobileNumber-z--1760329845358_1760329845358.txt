app.post("/api/send-otp", async (req, res) => {
    try {
      const { mobileNumber } = z
        .object({ mobileNumber: z.string() })
        .parse(req.body);

      const otp = Math.floor(10000 + Math.random() * 90000).toString();

      storage.saveOtp(mobileNumber, otp);

      const gupshupApiKey = process.env.GUPSHUP_API_KEY?.trim();
      const gupshupUserId = process.env.GUPSHUP_USER_ID?.trim();
      const dltTemplateId = "1207167325073593251";
      const principalEntityId = process.env.DLT_PRINCIPAL_ENTITY_ID?.trim();

      try {
        if (gupshupApiKey && gupshupUserId && principalEntityId) {
          const phoneNumber = mobileNumber.startsWith("91")
            ? mobileNumber
            : `91${mobileNumber}`;

          if (process.env.NODE_ENV === "development") {
            console.log(
              `[OTP DEBUG] Generated OTP for ${mobileNumber}: ${otp}`,
            );
            console.log(
              `[CREDENTIALS DEBUG] userId length: ${gupshupUserId?.length}, apiKey length: ${gupshupApiKey?.length}, principalEntityId length: ${principalEntityId?.length}`,
            );
          }

          const message = `OTP is ${otp} for Aspire For Her. Do not share the OTP for security reasons`;

          const response = await fetch(
            "https://enterprise.smsgupshup.com/GatewayAPI/rest",
            {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({
                method: "SendMessage",
                send_to: phoneNumber,
                msg: message,
                msg_type: "Text",
                userid: gupshupUserId,
                auth_scheme: "plain",
                password: gupshupApiKey,
                v: "1.1",
                format: "text",
                dltTemplateId: dltTemplateId,
                principalEntityId: principalEntityId,
                mask: "AspFoH",
              }),
            },
          );

          const responseText = await response.text();
          console.log(
            `Gupshup new SMS response for ${phoneNumber}:`,
            responseText,
            message,
            ".ended.",
          );
          console.log(JSON.stringify(message));

          if (!responseText.includes("success")) {
            console.error(
              `Gupshup SMS failed for ${phoneNumber}:`,
              responseText,
            );
          }
        } else {
          if (process.env.NODE_ENV === "development") {
            console.log(
              `OTP for ${mobileNumber}: ${otp}`,
              "(Gupshup credentials not configured)",
            );
          } else {
            console.log(
              "OTP generated; SMS not sent â€“ Gupshup credentials not configured",
            );
          }
        }

        res.json({ message: "OTP sent successfully", success: true });
      } catch (smsError) {
        console.error("SMS sending failed:", smsError);
        res.json({
          message: "OTP sent successfully",
          success: true,
        });
      }
    } catch (error) {
      res.status(400).json({ message: "Failed to send OTP" });
    }
  });